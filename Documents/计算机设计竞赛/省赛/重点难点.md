### 深度学习算法部分

//todo

### GUI界面部分

##### 数据的结构化读入和分析

首先通过文件的相对路径读入.raw文件及相应的支持文件；由于.raw文件中没有保存3D图像的尺寸信息，于是需要通过读取支持文件中的.npy文件读入尺寸信息；然后使用numpy中的reshape功能重构三维数组，并将其作为基础的数据存储格式单元；

```python
def slotChooseRawFile(self):
    # 选择文件
    fileName_image, fileType = QFileDialog.getOpenFileName(self,
                                                           "Choose File",
                                                           self.cwd + "/Data/image",  # 起始路径
                                                           "raw(*.raw)")  # 设置文件扩展名过滤,用双分号间隔
    # read into numpy
    if fileName_image != "":
        # load
        self.file_name = fileName_image.split("/")[-1].rstrip(".raw")
        self.shape = np.load(file="Data/npy/" + self.file_name + ".npy")
        self.image = np.fromfile(file="Data/image/" + self.file_name + ".raw", dtype=np.float32)
        self.background = np.fromfile(file="Data/background/" + self.file_name + ".raw", dtype=np.float32)
        self.label = np.fromfile(file="Data/label/" + self.file_name + ".raw", dtype=np.float32)
        # reshape
        self.image = self.image.reshape(self.shape[0], self.shape[1], self.shape[2])
        self.background = self.background.reshape(self.shape[0], self.shape[1], self.shape[2])
        self.label = self.label.reshape(self.shape[0], self.shape[1], self.shape[2])
        # update labels
        self.LabelValueX.setText(str(self.shape[2]))
        self.LabelValueY.setText(str(self.shape[1]))
        self.LabelValueZ.setText(str(self.shape[0]))
        self.ImagePath.setText("ImagePath:" + "Data/image/" + self.file_name + ".raw")
        self.BackgroundPath.setText("BackgroundPath:" + "Data/background/" + self.file_name + ".raw")
        self.LabelPath.setText("LabelPath: " + "Data/label/" + self.file_name + ".raw")
    else:
        QMessageBox.about(self, "LoadData", "No Raw File Selected!")
```

##### 3D图像的绘制、属性设置

基于Mayavi3D图形库实现3D可视化界面并使用Visualization类将其嵌入UI中；之后使用contour3d函数绘制3D管腔图像并更新信息；

```python
# 嵌入UI 
self.setupUi(self)
self.cwd = os.getcwd()  # 获取当前程序文件位置
self.visualization = Visualization()
self.mayaviWidget = self.visualization.edit_traits(
    parent=self, kind='subpanel').control
self.mayaviWidget.setParent(self.groupBoxMayavi)
self.verticalLayout.addWidget(self.mayaviWidget)
```

```python
def slotView3D(self):
    time_start = time.time()
    self.StateLabel.setText("Drawing...")
    QApplication.processEvents()
    self.visualization.scene.mlab.clf()
    contour = self.visualization.scene.mlab.contour3d(self.background, color=(1, 1, 0), opacity=0.5)
    self.visualization.scene.mlab.axes(xlabel='x', ylabel='y', zlabel='z', line_width=4)
    time_end = time.time()
    self.StateLabel.setText("Drawing Done in " + str(round(time_end - time_start, 2)) + " sec!")
    # update flags
    self.isLabelDrawn = False
    self.isPredictDrawn = False
    self.isContourDrawn = True
    self.isSliceDrawn = False
```

##### 与深度学习接口设置

调用Predict函数接口，参数为支持网络文件、图像尺寸、预测原图；函数会返回预测后的矩阵信息；

```python
def slotShowPredict(self):
    if not self.isPredictDrawn:
        time_start = time.time()
        self.StateLabel.setText("Predicting...")
        QApplication.processEvents()
        self.PredictResult = predict(self.Unet, self.shape, self.image, 1)
        self.StateLabel.setText("Drawing...")
        QApplication.processEvents()
        self.PredictObj = self.visualization.scene.mlab.contour3d(self.PredictResult,
                                                                  color=(1, 0, 0),
                                                                  opacity=1)
        time_end = time.time()
        self.StateLabel.setText("Prediction & Drawing Done in " + str(round(time_end - time_start, 2)) + " sec!")
        # update flags
        self.isPredictDrawn = True
    else:
        self.PredictObj.visible = True
```

##### GUI界面设计与按钮信号处理

基于PyQt5设计界面并使用qss文件美化界面；将上述函数封装为槽函数并在按钮点击时发送信号触发槽函数；

```python
# selectBtn connect
self.LoadData.clicked.connect(self.slotChooseRawFile)
# ViewBtn connect
self.View3D.clicked.connect(self.slotView3D)
self.ViewSlice.clicked.connect(self.slotViewSlice)
self.ShowLabel.clicked.connect(self.slotShowLabel)
self.HideLabel.clicked.connect(self.slotHideLabel)
self.ShowPredict.clicked.connect(self.slotShowPredict)
self.HidePredict.clicked.connect(self.slotHidePredict)
self.SaveFig.clicked.connect(self.slotSaveFig)
```

![ShowPredict](TyporaImg/ShowPredict.jpg)

<center><b>图1 GUI运行效果图</b></center>



